---
author: おーせ
pubDatetime: 2024-03-26
title: クリーンアーキテクチャについて少し考える
slug: laravel-clean-architecture
featured: false
draft: false
tags:
  - クリーンアーキテクチャ
  - Laravel
description:
  Laravel/Vueの実装においてDDDに則った実装を体験したので、その備忘録です。
---

## はじめに
今携わっている案件でLaravelにおけるクリーンアーキテクチャを勉強する必要があったので、その備忘録として学んだことを残します。<br />
4層のアーキテクチャ構成を採用しており、当初なぜアーキテクチャにこだわるかが恥ずかしながらわからなかったので、必要性と各層の役割などを簡単に掘り下げていけたらと思っています。<br />

## なぜアーキテクチャが必要なのか
最近企業の受託案件でも先方がどういったアーキテクチャを選定するかを求めてくることもあるとか、さすがになぜ必要かは認識しておかないとエンジニアとしてまずいと思いました。<br />
自分で調べた限り、クリーンアーキテクチャのメリットには共通して**可読性・保守性**といったワードが多かったです。<br />
責務の切り分けを一定のルールに乗っ取り行うことで**クラスやメソッド単位の役割が明確**になる。<br />
そういう積み重ねを丁寧にやっていけば、チームに誰かがジョインしたタイミングであっても、コードリーディングもしやすいため稼働が周りやすくなります。<br />
一昔前までは、今のものに比べるとハードウェアのCPUやメモリ数が低く、以下にメモリを使用せずCPUを浪費しないコードを書くかに重きがおかれていたようです。<br />
これは今でも気にすべきことですが、現在においてはアプリを長く運用するために**保守性が高く堅牢なアプリケーションに対して需要が高い**ため、クリーンアーキテクチャに対する知見が求められるのだと思います。

## アーキテクチャについて
アーキテクチャの名称云々は分かりませんが、以下4層の構成となっています。<br />
- Controller
- Usecase
- Service
- Repository

各層の役割についてそれぞれまとめていきます。
### Repository層
外部APIやORMによるDB操作などをRepository層で行なっています。<br />
複雑なロジックは書かないことを心がけ、何をする実装かを明確にした上で実装しました。<br />
例えば、TaskといったモデルのRepository層でuserIdにひもづくレコードを取得する実装は以下のようになります。<br />
(複雑な記載を避けた結果、逆に不自然な実装例となっていますがご容赦ください)
```php
// クラスやuse文は省略しています
public function fetch(int $id): Task
{
    return Task::find($id);
}
```
また、Taskモデルの1レコードを削除する実装は以下のようになります。<br />
```php

public function delete(int $id): Task
{
    return Task::find($id)->delete();
}

```
実務の中で以下の2点を注意されました。<br />
- 返り値voidは極力避けること
- 誰がみてもわかる名称にすること


それぞれ振り返っていけたらと思います。

#### 返り値voidは極力避ける
何かを作成したりするメソッドでも必要な場面が想定される場合は可能な限り返り値を指定することを指摘されました。<br />
これには大きく2つの意味があると思います。
- **汎用性高いメソッド**にするため

    実装するメソッドはRepository層であれば他の開発者も使う可能性があります。<br />
実装者の使用場面では`void`であっても他の実装者は返り値を求める可能性があります。<br />
後から実装しても良いですが、極力実装するタイミングである程度汎用的なメソッドにするために想定しうる返り値を指定することが大事なのかな、と理解しました。

- テストが書きやすくなる

    これは指摘していただいた方がおっしゃっていていたのですが、単体テストが書きやすくなるとのことでした。書きやすくなるというか、返り値まで想定してテストすることで**より堅牢なテスト設計が可能になる**という意味だと思います。<br />
テストが落ちなければ基本バグはでない、保守性の高いアプリを作るためにはテスト設計まで頭に入れる必要があるな、と思いました。<br />

#### 誰が見てもわかる名称にすること

例えば`Task`というモデルを取得するメソッドを実装する際に私は当初以下のような実装をしました。<br />

```php
public function fetchTask(int $userId): Task
{
    return Task::where('user_id', $userId)->get();
}
```
上の実装対して、「**fetchByUserIdとかにしましょう。TaskRepositoryのメソッドであればTaskは不要ですし、現状だと主キーによる取得と勘違いする可能性があります**」とレビューいただきました。<br />
こういったメソッド名を見て実装内容を判断できるのと、実装内容を見ないと理解できないのではコードリーディングの負担も変わります。一つ一つの命名規則も他の開発者の負担を考慮しなくては、と思いました。<br />
### Service層
サービス層は**ドメインロジック**を記述してほしい、とリードエンジニアの方から言われました。<br />
一方でUsecase層では**アプリケーションロジック**を記述してほしい、とのこと。<br />
それぞれどう違うのかがよくわからなかったので、調べてみました。
#### ドメインロジック
そもそもドメインとは、アプリケーションで扱うビジネス上の問題領域や範囲を指すようです。<br />
例えば、オンラインショップサービスのアプリケーションを例にとると、ドメインは商品、注文、顧客、支払いなどの要素で構成されます。商品という要素のドメインに関するロジックでは以下のような例が挙げられます。
- **在庫管理**

  商品の在庫数を追跡し、注文があった場合に在庫数を更新するなど<br />
- **価格設定**

  セールやキャンペーンなどの特別な価格設定や、数量割引、顧客ごとの割引などを管理するロジックなど<br />
- **商品カテゴリ**

  商品を適切なカテゴリーに分類方法<br />
- **配送と在庫の連携**

  注文が発生した場合、在庫を減らし、配送の準備を行うロジック<br />

つまり、Service層では上記の例のようなロジックをコードで表現する場所として考えて良さそうです。<br />
棲み分けはアプリケーションロジックを調べてから考えようかと思います。<br />
#### アプリケーションロジック
これはアプリがが実行する具体的な機能や手続きを指します。<br />
ドメインロジックを含むソフトウェア全体のロジックの一部ですが、ドメインロジックとは異なる側面があります。<br />
以下のようなロジックが例として挙げられます。<br />

- **ユーザー認証と認可**

  ユーザーがアプリケーションにログインする際の認証や、そのユーザーがどの機能やリソースにアクセスできるかを決定する認可ロジックなど<br />
- **エラーハンドリングや例外処理**

  アプリケーションがエラー状態になった場合の処理や、予期しない状況に対する例外処理<br />

ドメインロジックはビジネスドメイン全体をカバーし、一方でアプリケーションロジックはアプリ全体のルールやプロセスに関連するロジックを扱うようです。<br />

### Usecase層
Usecase層は先述のとおり、**アプリケーションロジック**を実装する層になります。<br />
私の案件では、以下のような実装をUsecase層で記述しています。<br />
- 認証情報の取得(リポジトリ層経由でAuthUserの取得など)
- DB操作に必要なトランザクションを貼る

などです。現状まで経験不足なので、実装箇所はそんなに広くはないのでご容赦を。。。<br />
考え方としてドメインロジックとして扱いきれないアプリケーション独自のルールなどをUsecaseに切り出すという理解らしいので、何か明確な線引きがあるとかではないらしいですね。<br />

### Controller層
フロントからRequestを受け取りUsecaseに渡した結果の返り値をViewに返すという処理に終始しています。<br />
受け取って返すという処理に留めておくことを心がけていますが、viewに返す変数の整形は行なっています。<br />
本来これは`ViewModel`を使って整形すべきかもしれませんが、実装上の負担と天秤にかけつつ複雑な処理にならなければ、コントローラで実装しています。

## 最後に
簡単に4層アーキテクチャそれぞれの役割と必要性について触れました。<br />
最後Controller層の箇所は息切れしたけど、一旦ここまでとさせていただきます。<br />
学んだことの簡単なメモ程度な記事ですが、これからも自分の考えをブログにアウトプットしていきます😀
